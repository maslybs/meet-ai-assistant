name: Deploy
on:
  push:
    branches: [main]
jobs:
  deploy:
    runs-on: [self-hosted, voice-ai]
    steps:
      - uses: actions/checkout@v4
      - name: Sync to working tree
        env:
          GH_URL: ${{ github.server_url }}
          GH_REPO: ${{ github.repository }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          dest=/home/voice-ai-assistant
          repo_url="https://x-access-token:${GITHUB_TOKEN}@${GH_URL#https://}/${GH_REPO}"
          mkdir -p "$dest"
          if ! git -C "$dest" rev-parse --is-inside-work-tree >/dev/null 2>&1; then
            git -C "$dest" init
            git -C "$dest" remote add origin "$repo_url"
          fi
          git -C "$dest" remote set-url origin "$repo_url"
          git -C "$dest" -c "url.$repo_url.insteadOf"="${GH_URL}" fetch --prune origin
          git -C "$dest" fetch origin "$GITHUB_SHA"
          git -C "$dest" checkout -f "$GITHUB_REF_NAME" || git -C "$dest" checkout -f main
          git -C "$dest" reset --hard "$GITHUB_SHA"
      - name: Install deps (Node)
        if: hashFiles('package.json') != ''
        run: |
          cd /home/voice-ai-assistant
          npm ci --omit=dev || npm install
      - name: Project deploy script (optional)
        run: |
          cd /home/voice-ai-assistant
          if [ -x ./deploy.sh ]; then ./deploy.sh; fi
      - name: Restart service
        run: sudo systemctl restart voice-ai.service
