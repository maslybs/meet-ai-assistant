name: Deploy
on:
  push:
    branches: [main]
jobs:
  deploy:
    runs-on: [self-hosted, voice-ai]
    steps:
      - uses: actions/checkout@v4
      - name: Sync to working tree
        env:
          GH_URL: ${{ github.server_url }}
          GH_REPO: ${{ github.repository }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          dest=/home/voice-ai-assistant
          mkdir -p "$dest"
          if ! git -C "$dest" rev-parse --is-inside-work-tree >/dev/null 2>&1; then
            git -c http.extraheader="AUTHORIZATION: bearer ${GITHUB_TOKEN}" \
              clone --depth=1 "${GH_URL}/${GH_REPO}" "$dest"
          else
            cd "$dest"
            git -c http.extraheader="AUTHORIZATION: bearer ${GITHUB_TOKEN}" fetch --prune
            git checkout -f "$GITHUB_REF_NAME" || git checkout -f main
            git reset --hard "$GITHUB_SHA"
      - name: Install deps (Node)
        if: hashFiles('package.json') != ''
        run: |
          cd /home/voice-ai-assistant
          npm ci --omit=dev || npm install
      - name: Project deploy script (optional)
        run: |
          cd /home/voice-ai-assistant
          if [ -x ./deploy.sh ]; then ./deploy.sh; fi
      - name: Restart service
        run: sudo systemctl restart voice-ai.service
