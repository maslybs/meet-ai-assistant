name: Deploy
on:
  push:
    branches: [main]
jobs:
  deploy:
    runs-on: [self-hosted, voice-ai]
    steps:
      - uses: actions/checkout@v4
      - name: Sync to working tree
        run: |
          set -e
          dest=/home/voice-ai-assistant
          mkdir -p "$dest"
          if ! git -C "$dest" rev-parse --is-inside-work-tree >/dev/null 2>&1; then
            # Тека існує, але не git-репо: очистити вміст, не видаляючи саму теку
            if [ -n "$(ls -A "$dest" 2>/dev/null)" ]; then
              find "$dest" -mindepth 1 -maxdepth 1 -exec rm -rf --one-file-system -- {} +
            fi
            git clone --depth=1 "$GITHUB_SERVER_URL/$GITHUB_REPOSITORY" "$dest"
          else
            cd "$dest"
            git fetch --prune
            git checkout -f "$GITHUB_REF_NAME" || git checkout -f main
            git reset --hard "$GITHUB_SHA"
          fi      - name: Install deps (Node)
        if: hashFiles('package.json') != ''
        run: |
          cd /home/voice-ai-assistant
          npm ci --omit=dev || npm install
      - name: Project deploy script (optional)
        run: |
          cd /home/voice-ai-assistant
          if [ -x ./deploy.sh ]; then ./deploy.sh; fi
      - name: Restart service
        run: sudo systemctl restart voice-ai.service
